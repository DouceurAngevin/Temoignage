<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Carrousel — infini, 2 pleines + peeks g/d</title>
<style>
  :root{
    --bg:#191919; --surface:#2f3437; --card:#2a2f32; --text:#f7f6f3; --muted:#9b9a97; --accent:#f1f1ef;
    --gap:14px;
    --peek:32px;
    --radius:12px;
    --shadow:0 18px 40px rgba(15,15,15,.55);
    --transition:600ms cubic-bezier(.22,.61,.36,1);
    --card-width: calc((100% - var(--gap)) / 2);
    color-scheme:dark;
  }
  *{ box-sizing:border-box; }

  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:16px/1.6 "Inter","Segoe UI",-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;
    padding: clamp(20px,4vh,36px) clamp(16px,4vw,28px);
    overflow-x:hidden;
  }

  .wrap{ width:100%; margin:0 auto; }
  .carousel{ position:relative; isolation:isolate; }

  .viewport{
    overflow:hidden;
    padding:6px var(--peek);
    position:relative;
    z-index:1;
    touch-action:pan-y;
  }

  .track{
    display:flex; align-items:stretch; gap:var(--gap);
    will-change:transform;
    transition: transform var(--transition);
    padding:8px 0;
  }

  .card{
    flex:0 0 var(--card-width);
    background:var(--card);
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:18px 18px 16px;
    display:grid; gap:12px; min-height:150px;
  }

  .quote{ font-size:16px; font-weight:600; letter-spacing:.01em; line-height:1.55; }
  .meta{ color:var(--muted); font-size:13px; line-height:1.5; white-space:pre-line; }

  .nav{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    width:34px; height:34px;
    display:grid; place-items:center;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.08);
    background:var(--surface);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
    backdrop-filter:blur(8px);
    cursor:pointer; user-select:none;
    transition: background .2s ease, opacity .2s ease;
    opacity:.95;
    z-index:1000;         /* Toujours au-dessus de tout */
    pointer-events:auto;  /* Toujours cliquables */
  }
  .nav:hover{ background:rgba(63,69,72,.85); opacity:1; }
  .prev{ left:8px; }
  .next{ right:8px; }
  .nav svg{ width:14px; height:14px; color:var(--accent); }

  @media (max-width:600px){
    :root{ --peek:18px; --gap:12px; --card-width:100%; }
    .card{ min-height:0; padding:16px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="carousel" aria-label="Carrousel de témoignages">
      <button class="nav prev" aria-label="Témoignages précédents">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </button>

      <div class="viewport">
        <div class="track" role="list">
          <article class="card" role="listitem"><div class="quote">“On a doublé notre taux de conversion.”</div></article>
          <article class="card" role="listitem"><div class="quote">“Les emails de relance ont relancé notre croissance.”</div></article>
          <article class="card" role="listitem"><div class="quote">“Enfin un messaging qui parle à nos clients.”</div></article>
          <article class="card" role="listitem"><div class="quote">“Le configurateur est devenu notre meilleur commercial.”</div></article>
          <article class="card" role="listitem"><div class="quote">“Nos appels concluent plus. Les scripts font la différence.”</div></article>
          <article class="card" role="listitem"><div class="quote">“Une ligne éditoriale qui fédère.”</div></article>
        </div>
      </div>

      <button class="nav next" aria-label="Témoignages suivants">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>
  </div>

<script>
(function(){
  const viewport = document.querySelector('.viewport');
  const track = document.querySelector('.track');
  const prevBtn = document.querySelector('.prev');
  const nextBtn = document.querySelector('.next');

  const STEP = 1;
  let slides = Array.from(track.children);
  let index = 0;

  const css  = (el, prop) => parseFloat(getComputedStyle(el)[prop]) || 0;
  const peek = () => css(viewport,'paddingLeft');
  const gap  = () => (getComputedStyle(track).columnGap ? css(track,'columnGap') : css(track,'gap'));
  const cardW= () => slides[0]?.getBoundingClientRect().width || 0;

  function getVisible(){
    const inner = viewport.getBoundingClientRect().width - css(viewport,'paddingLeft') - css(viewport,'paddingRight');
    const w = cardW() + gap();
    return Math.max(1, Math.floor((inner+gap()-1)/w));
  }

  function setupClones(){
    Array.from(track.children).forEach(n => { if(!n.dataset.original) n.remove(); });
    slides = Array.from(track.children);
    slides.forEach(n => n.dataset.original='1');

    const V = getVisible();
    const head = slides.slice(0, V+1).map(n => { const c=n.cloneNode(true); c.dataset.original=''; return c; });
    const tail = slides.slice(-V-1).map(n => { const c=n.cloneNode(true); c.dataset.original=''; return c; });
    tail.forEach(n => track.insertBefore(n, track.firstChild));
    head.forEach(n => track.appendChild(n));
    slides = Array.from(track.children);
    index = V+1;
    requestAnimationFrame(()=> goTo(index,false));
  }

  function goTo(i, withTransition=true){
    const x = - (i*(cardW()+gap())) + peek();
    track.style.transition = withTransition ? '' : 'none';
    track.style.transform = `translate3d(${x}px,0,0)`;
    index = i;
  }

  function next(){ goTo(index+STEP,true); }
  function prev(){ goTo(index-STEP,true); }

  track.addEventListener('transitionend', ()=>{
    const total = slides.length;
    const V = getVisible();
    if(index >= total-(V+1)) goTo(V+1,false);
    if(index <= V) goTo(total-(V+2),false);
  });

  prevBtn.addEventListener('click', prev);
  nextBtn.addEventListener('click', next);

  window.addEventListener('resize', setupClones);

  setupClones();
})();
</script>
</body>
</html>
